<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fixed Deposit Record</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        button {
            margin: 5px;
            padding: 5px 10px;
            cursor: pointer;
        }
        #accountHolderSelect {
            margin-bottom: 10px;
        }
        .interest-section, .saved-interest-section {
            margin-top: 30px;
            border-top: 1px solid #ddd;
            padding-top: 20px;
        }
        .form-group {
            margin: 10px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        .form-group label {
            margin-right: 10px;
        }
        input[type="number"], input[type="date"], input[type="file"], select {
            padding: 5px;
        }
        .hidden {
            display: none;
        }
        .renewal-green {
            color: green;
        }
        .renewal-yellow {
            color: yellow;
        }
        .renewal-red {
            color: red;
            animation: blinker 1s linear infinite;
        }
        @keyframes blinker {
            50% { opacity: 0; }
        }
        .expired-circle::after {
            content: " ðŸ”´";
        }
        .certificate-obtained {
            color: green;
        }
        .certificate-not-obtained {
            color: red;
        }
        @media (max-width: 768px) {
            .form-group {
                flex-direction: column;
                align-items: flex-start;
            }
            table {
                font-size: 14px;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="form-group">
            <label>Account Holder:
                <select id="accountHolderSelect"></select>
                <input type="text" id="newAccountHolder" placeholder="New Account Holder">
                <button id="addAccountHolderBtn">Add Account Holder</button>
            </label>
        </div>
        <h2>Fixed Deposit Record - <span id="accountHolderNameDisplay"></span></h2>

        <div class="form-group">
            <label>Bank Name:
                <select id="bankName">
                    <option value="Nabil Bank">Nabil Bank</option>
                    <option value="Nepal Investment Bank">Nepal Investment Bank</option>
                    <option value="Standard Chartered Bank">Standard Chartered Bank</option>
                    <option value="NIC Asia Bank">NIC Asia Bank</option>
                    <option value="Himalayan Bank">Himalayan Bank</option>
                    <option value="Global IME Bank">Global IME Bank</option>
                    <option value="Siddhartha Bank">Siddhartha Bank</option>
                    <option value="Prime Commercial Bank">Prime Commercial Bank</option>
                    <option value="Everest Bank">Everest Bank</option>
                    <option value="Citizens Bank">Citizens Bank</option>
                    <option value="Sanima Bank">Sanima Bank</option>
                    <option value="Kumari Bank">Kumari Bank</option>
                    <option value="Laxmi Bank">Laxmi Bank</option>
                    <option value="Machhapuchchhre Bank">Machhapuchchhre Bank</option>
                    <option value="Mega Bank">Mega Bank</option>
                    <option value="Sunrise Bank">Sunrise Bank</option>
                    <option value="NMB Bank">NMB Bank</option>
                    <option value="Prabhu Bank">Prabhu Bank</option>
                    <option value="Civil Bank">Civil Bank</option>
                    <option value="Century Commercial Bank">Century Commercial Bank</option>
                </select>
            </label>
            <label>Amount: <input type="number" id="amount" min="0" step="0.01"></label>
            <label>Duration:
                <input type="number" id="duration" min="1">
                <select id="durationUnit">
                    <option value="Days">Days</option>
                    <option value="Months">Months</option>
                    <option value="Years">Years</option>
                </select>
            </label>
            <label>Interest Rate (% per annum): <input type="number" id="interestRate" min="0" step="0.1" value="5"></label>
            <label>FD Start Date: <input type="date" id="fdStartDate"></label>
             <label>FD Certificate:
                <select id="fdCertificate">
                    <option value="obtained">Obtained</option>
                    <option value="not obtained">Not Obtained</option>
                </select>
            </label>
            <input type="hidden" id="editIndex">
            <button id="saveRecordBtn">Save Record</button>
            <button id="clearAllRecordsBtn">Clear All</button>
            <button id="exportToPDFBtn">Export to PDF</button>
            <button id="exportToExcelBtn">Export to Excel</button>
            <label>Import from Excel: <input type="file" id="importExcelFile" accept=".xlsx, .xls"></label>
            <button id="importExcelBtn">Import</button>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Bank Name</th>
                    <th>Amount</th>
                    <th>Duration</th>
                    <th>Duration Unit</th>
                    <th>Interest Rate</th>
                    <th>FD Start Date</th>
                    <th>FD Maturity Date</th>
                    <th>FD Renewal Days Remaining</th>
                    <th>Interest</th>
                     <th>FD Certificate</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="records"></tbody>
        </table>

        <div class="interest-section">
            <h2>Interest Calculation</h2>
            <div class="form-group">
                <label>Select FD Record:
                    <select id="fdRecordSelect"></select>
                </label>
                <label>Bank Name: <input type="text" id="interestBankName" readonly></label>
                <label>Amount: <input type="number" id="interestAmount" readonly></label>
                <label>Interest Calculation Period:
                    <select id="interestCalculationPeriod">
                        <option value="whole">Whole FD Period</option>
                        <option value="custom">Custom Date Range</option>
                        <option value="fullCustom">Full Custom Input</option>
                    </select>
                </label>
                <label class="hidden" id="customInterestAmountLabel">Amount: <input type="number" id="customInterestAmount" min="0" step="0.01"></label>
                <label class="hidden" id="customInterestRateLabel">Interest Rate (% per annum): <input type="number" id="customInterestRate" min="0" step="0.1"></label>
                <label class="hidden" id="customInterestDurationLabel">Duration: <input type="number" id="customInterestDuration" min="1"></label>
                <label class="hidden" id="customInterestDurationUnitLabel">
                    <select id="customInterestDurationUnit">
                        <option value="Days">Days</option>
                        <option value="Months">Months</option>
                        <option value="Years">Years</option>
                    </select>
                </label>
                <label class="hidden">From Date: <input type="date" id="interestFromDate"></label>
                <label class="hidden">To Date: <input type="date" id="interestToDate"></label>
                <button id="calculateInterestBtn">Calculate Interest</button>
                <p>Calculated Interest: <span id="calculatedInterest">0</span></p>
            </div>
        </div>

        <div class="saved-interest-section">
            <h2>Saved Interest Records</h2>
            <table class="saved-interest-table">
                <thead>
                    <tr>
                        <th>Account Holder</th>
                        <th>Bank Name</th>
                        <th>Amount</th>
                        <th>Interest Rate</th>
                        <th>Start Date</th>
                        <th>End Date</th>
                        <th>Interest Calculation Period</th>
                        <th>Interest</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="savedInterestList"></tbody>
            </table>
            <button id="clearAllSavedInterestBtn">Clear All</button>
            <button id="exportSavedInterestToPDFBtn">Export to PDF</button>
            <button id="exportSavedInterestToExcelBtn">Export to Excel</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize UI
            loadAccountHolders();
            document.getElementById('customInterestAmountLabel').classList.add('hidden');
            document.getElementById('customInterestRateLabel').classList.add('hidden');
            document.getElementById('customInterestDurationLabel').classList.add('hidden');
            document.getElementById('customInterestDurationUnitLabel').classList.add('hidden');
            document.querySelector('#interestFromDate').parentElement.classList.add('hidden');
            document.querySelector('#interestToDate').parentElement.classList.add('hidden');
            loadSavedInterest();

            // Attach event listeners to buttons
            document.getElementById('addAccountHolderBtn').addEventListener('click', addAccountHolder);
            document.getElementById('saveRecordBtn').addEventListener('click', saveRecord);
            document.getElementById('clearAllRecordsBtn').addEventListener('click', clearAllRecords);
            document.getElementById('exportToPDFBtn').addEventListener('click', exportToPDF);
            document.getElementById('exportToExcelBtn').addEventListener('click', exportToExcel);
            document.getElementById('importExcelBtn').addEventListener('click', importFromExcel);
            document.getElementById('calculateInterestBtn').addEventListener('click', calculateAndDisplayInterest);
            document.getElementById('clearAllSavedInterestBtn').addEventListener('click', clearAllSavedInterest);
            document.getElementById('exportSavedInterestToPDFBtn').addEventListener('click', exportSavedInterestToPDF);
            document.getElementById('exportSavedInterestToExcelBtn').addEventListener('click', exportSavedInterestToExcel);

            // Attach event listeners to dropdowns
            document.getElementById('accountHolderSelect').addEventListener('change', loadAccountRecords);
            document.getElementById('fdRecordSelect').addEventListener('change', updateInterestFields);
            document.getElementById('interestCalculationPeriod').addEventListener('change', function() {
                const period = this.value;
                const customFields = ['customInterestAmountLabel', 'customInterestRateLabel', 'customInterestDurationLabel', 'customInterestDurationUnitLabel'];
                const dateFields = document.querySelectorAll('#interestFromDate, #interestToDate');
                customFields.forEach(id => document.getElementById(id).classList.toggle('hidden', period !== 'fullCustom'));
                dateFields.forEach(field => field.parentElement.classList.toggle('hidden', period !== 'custom'));
            });
        });

        function getAccountHolders() {
            return JSON.parse(localStorage.getItem('accountHolders') || '[]');
        }

        function saveAccountHolders(accountHolders) {
            localStorage.setItem('accountHolders', JSON.stringify(accountHolders));
        }

        function loadAccountHolders() {
            const accountHolderSelect = document.getElementById('accountHolderSelect');
            accountHolderSelect.innerHTML = '';
            const accountHolders = getAccountHolders();
            accountHolders.forEach(holder => {
                const option = document.createElement('option');
                option.value = holder;
                option.textContent = holder;
                accountHolderSelect.appendChild(option);
            });
            if (accountHolders.length > 0) {
                accountHolderSelect.value = accountHolders[0];
                loadAccountRecords();
            } else {
                document.getElementById('accountHolderNameDisplay').textContent = "No Account Holder Selected";
                document.getElementById('records').innerHTML = '';
                document.getElementById('fdRecordSelect').innerHTML = '';
            }
        }

        function addAccountHolder() {
            const newAccountHolderInput = document.getElementById('newAccountHolder');
            const newAccountHolderName = newAccountHolderInput.value.trim();
            if (!newAccountHolderName) {
                alert("Please enter a valid account holder name.");
                return;
            }
            const accountHolders = getAccountHolders();
            if (!accountHolders.includes(newAccountHolderName)) {
                accountHolders.push(newAccountHolderName);
                saveAccountHolders(accountHolders);
                loadAccountHolders();
                document.getElementById('accountHolderSelect').value = newAccountHolderName;
            }
            newAccountHolderInput.value = '';
            loadAccountRecords();
        }

        function getAccountRecords(accountHolderName) {
            try {
                const data = localStorage.getItem(accountHolderName);
                return data ? JSON.parse(data) : [];
            } catch (error) {
                console.error('Error getting account records:', error);
                return [];
            }
        }

        function saveAccountRecords(accountHolderName, records) {
            try {
                localStorage.setItem(accountHolderName, JSON.stringify(records));
            } catch (error) {
                console.error('Error saving account records:', error);
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toISOString().split('T')[0];
        }

        function loadAccountRecords() {
            const accountHolderName = document.getElementById('accountHolderSelect').value;
            document.getElementById('accountHolderNameDisplay').textContent = accountHolderName || "No Account Holder Selected";
            const records = getAccountRecords(accountHolderName);
            const tbody = document.getElementById('records');
            tbody.innerHTML = '';
            records.forEach((record, index) => {
                const row = document.createElement('tr');
                const renewalDays = record.fdRenewalDaysRemaining;
                let renewalClass = '';
                if (renewalDays > 15) {
                    renewalClass = 'renewal-green';
                } else if (renewalDays >= 10 && renewalDays <= 14) {
                    renewalClass = 'renewal-yellow';
                } else if (renewalDays >= 1 && renewalDays <= 9) {
                    renewalClass = 'renewal-red';
                } else {
                    renewalClass = 'renewal-expired expired-circle';
                }
                const certificateClass = record.fdCertificate === 'obtained' ? 'certificate-obtained' : 'certificate-not-obtained';

                // Apply the class to the Bank Name and Amount cells
                const bankNameCell = `<td class="${renewalClass}">${record.bankName}</td>`;
                const amountCell = `<td class="${renewalClass}">${record.amount}</td>`;
                const renewalCell = `<td class="${renewalClass}">${renewalDays}</td>`;
                 const certificateCell = `<td class="${certificateClass}">${record.fdCertificate}</td>`;

                row.innerHTML = `
                    ${bankNameCell}
                    ${amountCell}
                    <td>${record.duration}</td>
                    <td>${record.durationUnit}</td>
                    <td>${record.interestRate}</td>
                    <td>${formatDate(record.fdStartDate)}</td>
                    <td>${formatDate(record.fdMaturityDate)}</td>
                    ${renewalCell}
                    <td>${record.interest.toFixed(2)}</td>
                    ${certificateCell}
                    <td>
                        <button class="editBtn" data-account="${accountHolderName}" data-index="${index}">Edit</button>
                        <button class="deleteBtn" data-account="${accountHolderName}" data-index="${index}">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            document.querySelectorAll('.editBtn').forEach(btn => {
                btn.addEventListener('click', () => editRecord(btn.dataset.account, btn.dataset.index));
            });
            document.querySelectorAll('.deleteBtn').forEach(btn => {
                btn.addEventListener('click', () => deleteRecord(btn.dataset.account, btn.dataset.index));
            });
            populateFDRecordSelect(records);
        }

        function calculateMaturityDate(startDate, duration, unit) {
            const date = new Date(startDate);
            const durationValue = parseInt(duration);
            if (unit === 'Days') date.setDate(date.getDate() + durationValue);
            else if (unit === 'Months') date.setMonth(date.getMonth() + durationValue);
            else if (unit === 'Years') date.setFullYear(date.getFullYear() + durationValue);
            return date.toISOString().split('T')[0];
        }

        function calculateRenewalDaysRemaining(maturityDate) {
            const today = new Date();
            const maturity = new Date(maturityDate);
            const diffTime = maturity - today;
            return Math.max(0, Math.ceil(diffTime / (1000 * 60 * 60 * 24)));
        }

        function calculateInterest(amount, interestRate, duration, unit, fromDate, toDate) {
            const principal = parseFloat(amount);
            const rate = parseFloat(interestRate) / 100;
            let days;
            if (fromDate && toDate) {
                const start = new Date(fromDate);
                const end = new Date(toDate);
                days = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
            } else {
                if (unit === 'Days') days = parseInt(duration);
                else if (unit === 'Months') days = Math.ceil((new Date().setMonth(new Date().getMonth() + parseInt(duration)) - new Date()) / (1000 * 60 * 60 * 24));
                else if (unit === 'Years') days = Math.ceil((new Date().setFullYear(new Date().getFullYear() + parseInt(duration)) - new Date()) / (1000 * 60 * 60 * 24));
            }
            return (principal * rate * days) / 365.25;
        }

        function validateInputs(bankName, amount, duration, interestRate, fdStartDate, fdCertificate) {
            if (!bankName || amount <= 0 || duration <= 0 || interestRate < 0 || !fdStartDate || !fdCertificate) {
                alert("Please fill all fields with valid values (Amount > 0, Duration > 0, Interest Rate >= 0).");
                return false;
            }
            return true;
        }

        function saveRecord() {
            const accountHolderName = document.getElementById('accountHolderSelect').value;
            if (!accountHolderName) {
                alert("Please select or add an account holder first.");
                return;
            }
            const bankName = document.getElementById('bankName').value;
            const amount = parseFloat(document.getElementById('amount').value) || 0;
            const duration = parseInt(document.getElementById('duration').value) || 0;
            const durationUnit = document.getElementById('durationUnit').value;
            const interestRate = parseFloat(document.getElementById('interestRate').value) || 0;
            const fdStartDate = document.getElementById('fdStartDate').value;
             const fdCertificate = document.getElementById('fdCertificate').value;

            if (!validateInputs(bankName, amount, duration, interestRate, fdStartDate, fdCertificate)) return;

            const fdMaturityDate = calculateMaturityDate(fdStartDate, duration, durationUnit);
            const fdRenewalDaysRemaining = calculateRenewalDaysRemaining(fdMaturityDate);
            const interest = calculateInterest(amount, interestRate, duration, durationUnit);
            
            const record = { bankName, amount, duration, durationUnit, interestRate, fdStartDate, fdMaturityDate, fdRenewalDaysRemaining, interest, fdCertificate };
            let records = getAccountRecords(accountHolderName);
            const editIndex = document.getElementById('editIndex').value;
            if (editIndex !== '') records[editIndex] = record;
            else records.push(record);
            saveAccountRecords(accountHolderName, records);
            loadAccountRecords();
            clearInputs();
        }

        function editRecord(accountHolderName, index) {
            if (confirm("Are you sure you want to edit this record?")) {
                const records = getAccountRecords(accountHolderName);
                const record = records[index];
                document.getElementById('bankName').value = record.bankName;
                document.getElementById('amount').value = record.amount;
                document.getElementById('duration').value = record.duration;
                document.getElementById('durationUnit').value = record.durationUnit;
                document.getElementById('interestRate').value = record.interestRate;
                document.getElementById('fdStartDate').value = record.fdStartDate;
                document.getElementById('fdCertificate').value = record.fdCertificate;
                document.getElementById('editIndex').value = index;
            }
        }

        function deleteRecord(accountHolderName, index) {
            if (confirm("Are you sure you want to delete this record?")) {
                let records = getAccountRecords(accountHolderName);
                records.splice(index, 1);
                saveAccountRecords(accountHolderName, records);
                loadAccountRecords();
            }
        }

        function clearInputs() {
            document.getElementById('bankName').value = 'Nabil Bank';
            document.getElementById('amount').value = '';
            document.getElementById('duration').value = '';
            document.getElementById('durationUnit').value = 'Days';
            document.getElementById('interestRate').value = '5';
            document.getElementById('fdStartDate').value = '';
            document.getElementById('fdCertificate').value = 'obtained';
            document.getElementById('editIndex').value = '';
        }

        function clearAllRecords() {
            const accountHolderName = document.getElementById('accountHolderSelect').value;
            if (!accountHolderName) {
                alert("No account holder selected.");
                return;
            }
            if (confirm("Are you sure you want to clear all records for this account holder?")) {
                localStorage.removeItem(accountHolderName);
                loadAccountRecords();
            }
        }

        function exportToPDF() {
            try {
                const accountHolderName = document.getElementById('accountHolderSelect').value;
                const records = getAccountRecords(accountHolderName);
                if (!records.length) {
                    alert("No records to export.");
                    return;
                }
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.text(`Fixed Deposit Records - ${accountHolderName}`, 10, 10);
                const tableData = records.map(r => [
                    r.bankName, r.amount.toString(), r.duration.toString(), r.durationUnit, r.interestRate.toString(),
                    formatDate(r.fdStartDate), formatDate(r.fdMaturityDate), r.fdRenewalDaysRemaining.toString(), r.interest.toFixed(2), r.fdCertificate
                ]);
                doc.autoTable({
                    head: [['Bank Name', 'Amount', 'Duration', 'Unit', 'Rate', 'Start Date', 'Maturity Date', 'Days Remaining', 'Interest', 'FD Certificate']],
                    body: tableData,
                    startY: 20
                });
                doc.save(`${accountHolderName}_FD_Records.pdf`);
            } catch (error) {
                console.error('Error exporting to PDF:', error);
                alert('Failed to export to PDF. Check the console for details.');
            }
        }

        function exportToExcel() {
            try {
                const accountHolderName = document.getElementById('accountHolderSelect').value;
                const records = getAccountRecords(accountHolderName);
                if (!records.length) {
                    alert("No records to export.");
                    return;
                }
                const data = records.map(r => ({
                    'Bank Name': r.bankName,
                    'Amount': r.amount,
                    'Duration': r.duration,
                    'Unit': r.durationUnit,
                    'Interest Rate': r.interestRate,
                    'Start Date': formatDate(r.fdStartDate),
                    'Maturity Date': formatDate(r.fdMaturityDate),
                    'Days Remaining': r.fdRenewalDaysRemaining,
                    'Interest': r.interest.toFixed(2),
                     'FD Certificate': r.fdCertificate
                }));
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'FD Records');
                XLSX.writeFile(wb, `${accountHolderName}_FD_Records.xlsx`);
            } catch (error) {
                console.error('Error exporting toExcel:', error);
                alert('Failed to export to Excel. Check the console for details.');
            }
        }

        function importFromExcel() {
            const accountHolderName = document.getElementById('accountHolderSelect').value;
            if (!accountHolderName) {
                alert("Please select an account holder before importing.");
                return;
            }
            const fileInput = document.getElementById('importExcelFile');
            const file = fileInput.files[0];
            if (!file) {
                alert("Please select an Excel file to import.");
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(sheet);
                    const records = jsonData.map(row => {
                        const bankName = row['Bank Name'] || '';
                        const amount = parseFloat(row['Amount']) || 0;
                        const duration = parseInt(row['Duration']) || 0;
                        const durationUnit = row['Unit'] || 'Days';
                        const interestRate = parseFloat(row['Interest Rate']) || 0;
                        const fdStartDate = row['Start Date'] || '';
                         const fdCertificate = row['FD Certificate'] || 'not obtained';
                        if (!validateInputs(bankName, amount, duration, interestRate, fdStartDate, fdCertificate)) {
                            throw new Error(`Invalid data in row: ${JSON.stringify(row)}`);
                        }
                        const fdMaturityDate = calculateMaturityDate(fdStartDate, duration, durationUnit);
                        const fdRenewalDaysRemaining = calculateRenewalDaysRemaining(fdMaturityDate);
                        const interest = calculateInterest(amount, interestRate, duration, durationUnit);
                        return { bankName, amount, duration, durationUnit, interestRate, fdStartDate, fdMaturityDate, fdRenewalDaysRemaining, interest, fdCertificate };
                    });
                    let existingRecords = getAccountRecords(accountHolderName);
                    existingRecords = existingRecords.concat(records);
                    saveAccountRecords(accountHolderName, existingRecords);
                    loadAccountRecords();
                    alert("Records imported successfully!");
                    fileInput.value = '';
                } catch (error) {
                    console.error('Error importing from Excel:', error);
                    alert('Failed to import records. Check the console for details.');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function populateFDRecordSelect(records) {
            const fdRecordSelect = document.getElementById('fdRecordSelect');
            fdRecordSelect.innerHTML = '';
            records.forEach((record, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${record.bankName} - ${record.amount}`;
                fdRecordSelect.appendChild(option);
            });
            if (records.length > 0) updateInterestFields();
        }

        function updateInterestFields() {
            const accountHolderName = document.getElementById('accountHolderSelect').value;
            const records = getAccountRecords(accountHolderName);
            const fdRecordIndex = document.getElementById('fdRecordSelect').value;
            if (records && records[fdRecordIndex]) {
                const record = records[fdRecordIndex];
                document.getElementById('interestBankName').value = record.bankName;
                document.getElementById('interestAmount').value = record.amount;
            } else {
                document.getElementById('interestBankName').value = '';
                document.getElementById('interestAmount').value = '';
            }
        }

        let calculatedInterestValue = 0;
        let calculatedInterestRecord = {};
        function calculateAndDisplayInterest() {
            const accountHolderName = document.getElementById('accountHolderSelect').value;
            if (!accountHolderName) {
                document.getElementById('calculatedInterest').textContent = "No account holder selected.";
                return;
            }
            const records = getAccountRecords(accountHolderName);
            const fdRecordIndex = document.getElementById('fdRecordSelect').value;
            if (!records || records.length === 0) {
                document.getElementById('calculatedInterest').textContent = "No records found.";
                return;
            }
            if (!records[fdRecordIndex]) {
                document.getElementById('calculatedInterest').textContent = "No FD Record Selected.";
                return;
            }
            const record = records[fdRecordIndex];
            let amount = record.amount;
            let interestRate = record.interestRate;
            let duration = record.duration;
            let unit = record.durationUnit;
            const period = document.getElementById('interestCalculationPeriod').value;
            const fromDate = document.getElementById('interestFromDate').value;
            const toDate = document.getElementById('interestToDate').value;
            if (period === 'fullCustom') {
                amount = parseFloat(document.getElementById('customInterestAmount').value) || 0;
                interestRate = parseFloat(document.getElementById('customInterestRate').value) || 0;
                duration = parseFloat(document.getElementById('customInterestDuration').value) || 0;
                unit = document.getElementById('customInterestDurationUnit').value;
                if (amount <= 0 || interestRate < 0 || duration <= 0) {
                    document.getElementById('calculatedInterest').textContent = "Please enter valid values.";
                    return;
                }
            }
            let interest = 0;
            if (period === 'whole') interest = calculateInterest(amount, interestRate, duration, unit);
            else if (period === 'custom') {
                if (!fromDate || !toDate || new Date(fromDate) > new Date(toDate)) {
                    document.getElementById('calculatedInterest').textContent = "Please select valid From and To dates.";
                    return;
                }
                interest = calculateInterest(amount, interestRate, duration, unit, fromDate, toDate);
            } else if (period === 'fullCustom') interest = calculateInterest(amount, interestRate, duration, unit);
            calculatedInterestValue = interest.toFixed(2);
            document.getElementById('calculatedInterest').textContent = calculatedInterestValue;
            calculatedInterestRecord = {
                accountHolderName,
                bankName: document.getElementById('interestBankName').value,
                amount,
                interestRate,
                fdStartDate: fromDate || record.fdStartDate,
                fdMaturityDate: toDate || record.fdMaturityDate,
                interest: calculatedInterestValue,
                interestCalculationPeriod: period
            };
            saveCalculatedInterest();
        }

        function getSavedInterest() {
            return JSON.parse(localStorage.getItem('savedInterest') || '[]');
        }

        function saveCalculatedInterest() {
            let savedInterestRecords = getSavedInterest();
            savedInterestRecords.push(calculatedInterestRecord);
            localStorage.setItem('savedInterest', JSON.stringify(savedInterestRecords));
            loadSavedInterest();
            document.getElementById('calculatedInterest').textContent = '0';
        }

        function loadSavedInterest() {
            const savedInterestList = document.getElementById('savedInterestList');
            savedInterestList.innerHTML = '';
            const savedInterestRecords = getSavedInterest();
            savedInterestRecords.forEach((record, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.accountHolderName}</td>
                    <td>${record.bankName}</td>
                    <td>${record.amount}</td>
                    <td>${record.interestRate}</td>
                    <td>${formatDate(record.fdStartDate)}</td>
                    <td>${formatDate(record.fdMaturityDate)}</td>
                    <td>${record.interestCalculationPeriod}</td>
                    <td>${record.interest}</td>
                    <td>
                        <button class="editSavedBtn" data-index="${index}">Edit</button>
                        <button class="deleteSavedBtn" data-index="${index}">Delete</button>
                    </td>
                `;
                savedInterestList.appendChild(row);
            });
            document.querySelectorAll('.editSavedBtn').forEach(btn => {
                btn.addEventListener('click', () => editSavedInterest(btn.dataset.index));
            });
            document.querySelectorAll('.deleteSavedBtn').forEach(btn => {
                btn.addEventListener('click', () => deleteSavedInterest(btn.dataset.index));
            });
        }

        function editSavedInterest(index) {
            if (confirm("Are you sure you want to edit this saved interest record?")) {
                const savedInterestRecords = getSavedInterest();
                const record = savedInterestRecords[index];
                document.getElementById('accountHolderSelect').value = record.accountHolderName;
                loadAccountRecords();
                document.getElementById('interestBankName').value = record.bankName;
                document.getElementById('interestAmount').value = record.amount;
                document.getElementById('customInterestAmount').value = record.amount;
                document.getElementById('customInterestRate').value = record.interestRate;
                document.getElementById('interestFromDate').value = record.fdStartDate;
                document.getElementById('interestToDate').value = record.fdMaturityDate;
                document.getElementById('interestCalculationPeriod').value = record.interestCalculationPeriod;
                calculatedInterestValue = record.interest;
                document.getElementById('calculatedInterest').textContent = calculatedInterestValue;
                savedInterestRecords.splice(index, 1);
                localStorage.setItem('savedInterest', JSON.stringify(savedInterestRecords));
                loadSavedInterest();
            }
        }

        function deleteSavedInterest(index) {
            if (confirm("Are you sure you want to delete this saved interest record?")) {
                let savedInterestRecords = getSavedInterest();
                savedInterestRecords.splice(index, 1);
                localStorage.setItem('savedInterest', JSON.stringify(savedInterestRecords));
                loadSavedInterest();
            }
        }

        function clearAllSavedInterest() {
            if (confirm("Are you sure you want to clear all saved interest records?")) {
                localStorage.removeItem('savedInterest');
                loadSavedInterest();
            }
        }

        function exportSavedInterestToPDF() {
            try {
                const savedInterestRecords = getSavedInterest();
                if (!savedInterestRecords.length) {
                    alert("No saved interest records to export.");
                    return;
                }
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.text("Saved Interest Records", 10, 10);
                const tableData = savedInterestRecords.map(r => [
                    r.accountHolderName, r.bankName, r.amount.toString(), r.interestRate.toString(),
                    formatDate(r.fdStartDate), formatDate(r.fdMaturityDate), r.interestCalculationPeriod, r.interest
                ]);
                doc.autoTable({
                    head: [['Holder', 'Bank Name', 'Amount', 'Rate', 'Start Date', 'End Date', 'Period', 'Interest']],
                    body: tableData,
                    startY: 20
                });
                doc.save('Saved_Interest_Records.pdf');
            } catch (error) {
                console.error('Error exporting saved interest to PDF:', error);
                alert('Failed to export saved interest to PDF. Check the console for details.');
            }
        }

        function exportSavedInterestToExcel() {
            try {
                const savedInterestRecords = getSavedInterest();
                if (!savedInterestRecords.length) {
                    alert("No saved interest records to export.");
                    return;
                }
                const data = savedInterestRecords.map(r => ({
                    'Account Holder': r.accountHolderName,
                    'Bank Name': r.bankName,
                    'Amount': r.amount,
                    'Interest Rate': r.interestRate,
                    'Start Date': formatDate(r.fdStartDate),
                    'End Date': formatDate(r.fdMaturityDate),
                    'Period': r.interestCalculationPeriod,
                    'Interest': r.interest
                }));
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Saved Interest');
                XLSX.writeFile(wb, 'Saved_Interest_Records.xlsx');
            } catch (error) {
                console.error('Error exporting saved interest to Excel:', error);
                alert('Failed to export saved interest to Excel. Check the console for details.');
            }
        }
    </script>
</body>
</html>
